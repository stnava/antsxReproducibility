---
title: "SRPB traveling subjects reproducibility analysis"
author: "Brian B. Avants"
date: "`r Sys.Date()`"
output: rmarkdown::html_document
---

```{r global options, include=FALSE}
library(knitr)
library(ANTsR)
library( ggplot2 )
require(grid)
require(gridExtra)
library( tidyr )
library("ggthemes")
library( ggthemr )
library(SimplyAgree)
library(DescTools)
library( subtyper )
theme_set(
    theme_classic(base_size = 25)
)
ggthemr("flat",text_size=20,spacing=1.3)
update_geom_defaults("point", list(size = 4))

```

> "if not now, when?"


## reproducibility analysis for antspyt1w results

this documents different approaches to looking at reproducibility in numeric
summary data derived from T1w images by ANTsX methods.

the `csv` results are generated from antspyt1w version 0.3.3.

* report overall reproducibility for a given region

* report a summary of cross-site agreement for a given region

* potentially look at effect sizes (though the variables are limited for this)

* we should distill the best of these measurements to a single funtion and
then run on all of our derived variables --- thereby assigning specific
confidence to different measurements that we have.

* the `tarAnat` and `anatcsv` values should match.  the analysis is
then performed on whatever `roi$Description` matches the `tarAnat` `grep`.

* the Achieva appears to have the highest quality wrt `cnr` and `snr_total`.

* overall, YC1 is among the best sites.

```{r importantParameters}
excludeScanners = c(  ) # eliminate the really bad scanner
# excludeScanners = c( "Signa" ) #, "MR", "Achieva" )
onlyDayOne = TRUE # eliminate the multi-day data collected only at one site
# mtl
anatcsv='mtl.csv'
tarAnat=c( 'parahippocampal'  )
tarAnat=c( 'parah' )
anatcsv='tissues.csv'
tarAnat=c( "DeepGray", "WM", "GM" )

# nbm
tarAnat='CH13'
# tarAnat=c('NBM_right_pos', 'NBM_left_pos')
anatcsv='bf.csv'

# mid
anatcsv='cit168.csv'
tarAnat=c( 'SNc', 'SNr' )
tarAnat=c( 'Pu', 'Ca' )

anatcsv='dktcortex.csv'
anatcsv='mtl.csv'

tarAnat=c( 'perirhinal' )

anatcsv='cit168.csv'
tarAnat=c( 'SNc')
post=c('SRHIER','')[2]

```


```{r,echo=FALSE}
multigrep <- function( x, desc ) {
  roisel = c()
  for ( xx in x )
    roisel = c( roisel, grep(xx, desc) )
  return(  roisel )
}

library(ANTsR)
rdir=path.expand("~/code/antsxReproducibility")
dd=read.csv(paste0( rdir, "/SRPBTravel/participants.csv"))
qct1 = read.table( paste0( rdir, "/QC/group_T1w.tsv"),header=TRUE)
qct1$participants_id=gsub("_T1w","",qct1$bids_name)
qct1$participants_id=gsub("_run-01","",qct1$participants_id)
dd = merge(dd,qct1,by='participants_id')
usubs = unique( dd$Subject )
usite = unique( dd$Site )
uscan = unique( dd$Scanner )
for ( j in 1:nrow(dd)) {
  myid = dd[j,"participants_id"]
  fn = paste0( rdir, "/SRPBTravel/", myid,
    "/T1wHierarchical/SRPBTravel-",myid,"-T1wHierarchical-",post,anatcsv)
  if ( j==1 ) print(fn)
  if( file.exists( fn ) ) {
    roi = read.csv( fn )
    roisel = multigrep(tarAnat,roi$Description)
    dd[j,"outcome"] = sum(roi$VolumeInMillimeters[roisel])
    }
  }
dd=dd[!is.na(dd$outcome),]
if ( onlyDayOne ) dd = dd[  dd$Day == 1, ]
if ( length( excludeScanners ) > 0 )
  dd=dd[ ! (dd$Scanner %in% excludeScanners ),] # eliminate the really bad scanner
```


```{r ddoutlieranalysis,echo=FALSE,eval=TRUE}
oldf = data.frame()
for ( j in 1:nrow(dd)) {
  myid = dd[j,"participants_id"]
  fn = Sys.glob( paste0( rdir, "/SRPBTravel/", myid,
    "/T1wHierarchical/SRPBTravel-",myid,"-T1wHierarchical-",post,"rbp.csv") )
  if( file.exists( fn ) ) {
    temp = read.csv( fn )[,-1]
    if ( j == 1 ) oldf = temp else oldf = rbind(oldf,temp)
    }
  }
oldf = subtyper::outlierness( oldf, calck=24 )
ddOL = cbind(dd,oldf[,grep("OL_",names(oldf))])

olnames = names(oldf)[ grep("OL_",names(oldf)) ]
for ( nm in olnames ) {
  print(nm)
  print(table( ddOL$Scanner, ddOL[,nm] > quantile( ddOL[,nm], 0.66 ) ))
}

dd$OL_LOOP=ddOL$OL_LOOP
```


## table of scanners involved here

```{r,echo=FALSE}
pander::pander( table( dd$Scanner ) )
```


## show volumes for one subject at different sites

```{r onesub3bars,fig.width=17,fig.height=6,echo=FALSE}
ggthemr("flat")
nvols = length( roi$Description[roisel] )
dfvols = data.frame( matrix( nrow=3, ncol=nvols+1) )
colnames(dfvols)=c("ID",roi$Description[roisel])
ct=0
for ( j in  which( dd$Subject == "MP004" ) ) {
  myid = dd[j,"participants_id"]
  fn = paste0( rdir, "/SRPBTravel/", myid,
    "/T1wHierarchical/SRPBTravel-",myid,"-T1wHierarchical-", anatcsv )
  if( file.exists( fn ) ) {
    roi = read.csv( fn )
    ct=ct+1
    roisel = multigrep(tarAnat,roi$Description)
    dfvols[ct,] = c(  dd[j,"Scanner"], (roi$VolumeInMillimeters[roisel]) )
    }
  }
dflong = pivot_longer( dfvols, names(dfvols)[-1] )
dflong$ID=factor(dflong$ID)
names(dflong)=c("ID","Anat","Volume")
dflong$Volume = as.numeric( dflong$Volume )
ylims = c( median(dflong$Volume ), max(dflong$Volume)+0.05*max(dflong$Volume))
ggplot(dflong, aes(fill=ID, y=Volume, x=Anat)) +
    geom_bar(position="dodge", stat="identity")+
      theme(text = element_text(size=22),
        axis.text.x = element_text(angle=0, hjust=1))
```


## Summmary  reliability data: statistical measures of reproducibility

```{r,fig.width=14,fig.height=4,echo=FALSE}
# now site reliability
mypw = pivot_wider( dd, id_cols='Subject',
  names_from=c("Site"), values_from="outcome" )
myiccs = ICC( mypw[,-1] )
pander::set.caption(paste( "Site ICC2k - average k raters"))
pander::pander( myiccs$results[5,1:6] )

print( reli_stats( "outcome", "Scanner", "Subject", data=dd ) )
plot( reli_stats( "outcome", "Scanner", "Subject", data=dd ) )

```

## Demonstrate effect of subject vs effect of Scanner or Site: Raw data plots

```{r plotbysubject,fig.width=12,fig.height=12,eval=FALSE,echo=FALSE,message=FALSE}
library(GGally)
mycols = c('age', 'outcome', 'Site', 'Day','Phase','Manufacture','Coil','Scanner')
mycols = c('age', 'outcome', 'Site', 'Scanner')
nna = ! is.na( dd$outcome )
print(
  ggpairs(data = dd[nna, c('Subject',mycols)] ) )
#    mapping = ggplot2::aes_string(color = 'Subject'),
#        columns = mycols,
#        upper = list(continuous = "cor",
#                     combo = "box_no_facet",
#                     discrete = "facetbar",
#                     na = "na"),
#        lower = list(continuous = "points",
#                     combo = "facethist",
#                     discrete = "facetbar",
#                     na = "na"),
#        diag = list(continuous = "densityDiag",
#                    discrete = "barDiag",
#                    na = "naDiag"),
#        xlab = 'X',
#        ylab = 'Y',
#    title = 'Exploratory correlations:')


```

```{r gg2,fig.width=16,fig.height=5,echo=FALSE}
ggthemr("fresh",text_size=20,spacing=1.3)
  ggplot(dd, aes(x = Subject, y = outcome, color = Site)) +
  geom_jitter(width=0.2,height=0.2) + ggtitle("Site")
```


```{r gg2site,fig.width=16,fig.height=5,echo=FALSE}
ggplot(dd, aes(x = Subject, y = outcome, color = Scanner)) +
  geom_jitter(width=0.2,height=0.2) + ggtitle("Scanner") #+geom_point(size=3)
```


## Demonstrate effects of controlling for different variables with regression



What is the fit of the model if we predict with subject alone?
```{r statsage,fig.width=10,fig.height=4}
mdl=(lm( outcome ~  1 + Subject + 1 , data=dd ))
rsq2 = format(summary( mdl )$r.squared,digits=3)
visreg::visreg( mdl, "Subject", gg=TRUE ) + ggtitle(paste("Subject only R^2:",rsq2))
```

What is the variability of the measurement if we add manufacturer?
```{r statsageb,fig.width=10,fig.height=4}
if ( length( unique(dd$Manufacture)) > 1 ) {
  mdl=(lm( outcome ~  Manufacture + Subject + OL_LOOP , data=dd ))
  rsq2 = format(summary( mdl )$r.squared,digits=3)
  visreg::visreg( mdl, "Subject", gg=TRUE ) + ggtitle(paste("Subject + Mfg R^2:",rsq2))
  }
```

What is the reproducibility of the measurement if add scanner?
```{r stats,fig.width=10,fig.height=4}

mdl=(lm( outcome ~   Subject + OL_LOOP + Scanner , data=dd ))
rsq2 = format(summary( mdl )$r.squared,digits=3)
visreg::visreg( mdl, "Subject", gg=TRUE ) + ggtitle(paste("Subject + scanner R^2:",rsq2))
```

What is the accuracy of the model if we add site?
```{r stats2c,fig.width=10,fig.height=4}
mdl=(lm( outcome ~   Subject + OL_LOOP + Site, data=dd ))
rsq2 = format(summary( mdl )$r.squared,digits=3)
visreg::visreg( mdl, "Subject", gg=TRUE ) + ggtitle(paste("Subject + site R^2:",rsq2))
```


What is the effect of total SNR?
```{r stats2b,fig.width=10,fig.height=4}

mdl=(lm( outcome ~   Subject + OL_LOOP + Scanner + snr_total , data=dd ))
rsq2 = format(summary( mdl )$r.squared,digits=3)
visreg::visreg( mdl, 'snr_total', gg=TRUE )+ ggtitle(paste("Subject + scanner + snr R^2:",rsq2))
```


What is the effect of gray matter SNR?
```{r stats3,fig.width=10,fig.height=4}

mdl=(lm( outcome ~   Subject + OL_LOOP + Scanner + snr_gm , data=dd ))
rsq2 = format(summary( mdl )$r.squared,digits=3)
visreg::visreg( mdl, 'snr_gm', gg=TRUE )+ ggtitle(paste("Subject + scanner + gm snr R^2:",rsq2))

```



What is the effect of motion confounds?

see the discussion of MRIQC [here](https://cpb-us-w2.wpmucdn.com/sites.brown.edu/dist/0/278/files/2021/10/MRIQC.pdf)


```{r statsnorun,echo=FALSE,eval=FALSE,fig.width=10,fig.height=4}
qnms=names(dd)[13:80]
for ( qnm in qnms ) {
  mdl=(lm( paste0("outcome ~   Subject + Scanner + ", qnm) , data=dd ))
  mycoffs=coefficients(summary(mdl))
  if ( mycoffs[qnm,4] < 0.01 )  {
    print(mycoffs)
    print(visreg::visreg( mdl, qnm, gg=TRUE ))
    Sys.sleep( 1 )
  }
}
```


What is the reproducibility of the measurement if we control for a motion specific variable?

```{r stats2,fig.width=10,fig.height=4}

mdl=(lm( outcome ~   Subject + OL_LOOP + Scanner + efc , data=dd ))
rsq2 = format(summary( mdl )$r.squared,digits=3)
visreg::visreg( mdl, 'efc', gg=TRUE )+ ggtitle(paste("Subject + scanner + efc R^2:",rsq2))

# grid.arrange( grobs = visreg::visreg( mdl, gg=TRUE ), ncol=1, main='reproducibility' )
```

##  Site-wise reliability

```{r,fig.width=12,fig.height=12,echo=FALSE}
library(irr)
myvar='Site'
# myvar='Scanner'
uscans=unique(dd[,myvar])
nVars=length(uscans)
iccdf = matrix(0,nrow=nVars,ncol=nVars)
uscansNam=uscans
for ( j in 1:nVars ) {
  ddscanj = dd[dd[,myvar]==uscans[j] & dd$Day==1,]
  uscansNam[j]=paste0(uscansNam[j],unique(ddscanj$Scanner))
}
rownames(iccdf)=uscansNam
colnames(iccdf)=uscansNam
for ( k in 1:nVars) {
  for (j in 1:nVars) {
  if ( TRUE) {
    subsloc =  intersect(
      dd[dd[,myvar]==uscans[k],"Subject"],
      dd[dd[,myvar]==uscans[j],"Subject"] )
    ddscanj = dd[dd[,myvar]==uscans[j] & dd$Day==1,]
    ddscank = dd[dd[,myvar]==uscans[k] & dd$Day==1,]
    sdf=data.frame(
      V0=ddscank[ ddscank[,"Subject"] %in% subsloc,"outcome"],
      V1=ddscanj[ ddscanj[,"Subject"] %in% subsloc,"outcome"] )
    iccSR = irr::icc( sdf[,c("V0","V1")],
      model = "oneway", type = "agreement", unit = "single" )$value # ,1,5)
    iccdf[k,j]=iccSR
    }
  }}#
# pheatmap::pheatmap(iccdf,display_numbers=T)
library(corrplot)
corrplot.mixed(iccdf,is.corr=F)
# corrplot::corrplot(iccdf, method = 'shade', order = 'AOE', diag = FALSE)
library("gplots")
heatmap.2(iccdf, scale = "none", col = bluered(100),
          trace = "none", density.info = "none")
```



```{r,echo=FALSE,eval=FALSE}
achievaPIDs=dd$participants_id[ dd$Scanner == "Achieva" ]
achievaSubs=dd$Subject[ dd$Scanner == "Achieva" ]
achievaSites=dd$Site[ dd$Scanner == "Achieva" ]
usubs = unique( achievaSubs )
bestSIDsYC1 = dd$Subject[ dd$Site == "YC1" ]
bestSIDsHUH = dd$Subject[ dd$Site == "HUH" ]
bestPIDsYC1 = dd$participants_id[ dd$Site == "YC1" ]
bestPIDsHUH = dd$participants_id[ dd$Site == "HUH" ]

# form a data frame with the necessary mappings
for ( k in 1:nrow( dd ) ) {
  sid = dd$Subject[ k ]
  if ( sid %in% bestSIDsYC1 ) {
    gtid = bestPIDsYC1[  which(bestSIDsYC1 == sid ) ]
    gtidk = which( dd$participants_id == gtid )
  } else if ( sid %in% bestSIDsHUH ) {
    gtid = bestPIDsHUH[  which(bestSIDsHUH == sid ) ]
    gtidk = which( dd$participants_id == gtid )
    }
  # get the images
#  ./SRPBTravel/sub-042/T1wHierarchical/SRPBTravel-sub-042-T1wHierarchical-SRHIERbrain_n4_dnz.nii.gz
  exts = c("-SRHIERbrain_n4_dnz.nii.gz","-cit168lab.nii.gz","-bf.nii.gz")
  gtfn = paste0( rdir, "/SRPBTravel/", dd$participants_id[gtidk], "/T1wHierarchical/SRPBTravel-", dd$participants_id[gtidk], "-T1wHierarchical", exts )
  gtImage = antsImageRead( gtfn[1] )
  gtImageCIT = antsImageRead( gtfn[2] )
  gtImageBF = antsImageRead( gtfn[3] )
  tarfn = paste0( rdir, "/SRPBTravel/", dd$participants_id[k], "/T1wHierarchical/SRPBTravel-", dd$participants_id[k], "-T1wHierarchical", exts )
  targetImage = antsImageRead( tarfn[1] )
  targetImageCIT = antsImageRead( tarfn[2] )
  targetImageBF = antsImageRead( tarfn[3] )
  temp=histogramMatchImage( targetImage, gtImage,
    numberOfHistogramBins = 48, numberOfMatchPoints=12 )
  rigidreg = antsRegistration( temp, gtImage, 'Rigid' )
  citmap = antsApplyTransforms( targetImage, gtImageCIT, rigidreg$fwdtransforms, interpolator='genericLabel')
  bfmap = antsApplyTransforms( targetImage, gtImageBF, rigidreg$fwdtransforms, interpolator='genericLabel')
  outfn = paste0( "SRPBtrainingData/", dd$participants_id[k], exts )
  antsImageWrite( targetImage, outfn[1] )
  antsImageWrite( citmap, outfn[2] )
  antsImageWrite( targetImage, outfn[3] )
  }

```
